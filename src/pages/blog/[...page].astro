---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import SearchBox from "../../components/SearchBox.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import DefaultImage from "../../assets/blog-placeholder-1.jpg";

export const getStaticPaths = (async ({ paginate }) => {
    const posts = (await getCollection("blog")).sort(
        (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
    );

    return paginate(posts, { pageSize: 12 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// Obtener todos los códigos únicos para los filtros
const allCodes = [
    ...new Set(page.data.map((post) => post.data.code).filter(Boolean)),
].sort();
---

<!doctype html>
<html lang="es">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
        <style>
            main {
                width: 960px;
            }
            ul {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem;
                list-style-type: none;
                margin: 0;
                padding: 0;
            }
            ul li {
                width: calc(50% - 1rem);
            }
            ul li * {
                text-decoration: none;
                transition: 0.2s ease;
            }
            ul li:first-child {
                width: 100%;
                margin-bottom: 1rem;
                text-align: center;
            }
            ul li:first-child img {
                width: 100%;
            }
            ul li:first-child .title {
                font-size: 2.369rem;
            }
            ul li img {
                margin-bottom: 0.5rem;
                border-radius: 12px;
            }
            ul li a {
                display: block;
            }
            .title {
                margin: 0;
                color: rgb(var(--black));
                line-height: 1;
            }
            .date {
                margin: 0;
                color: rgb(var(--gray));
            }
            ul li a:hover h4,
            ul li a:hover .date {
                color: rgb(var(--accent));
            }
            ul a:hover img {
                box-shadow: var(--box-shadow);
            }
            @media (max-width: 720px) {
                ul {
                    gap: 0.5em;
                }
                ul li {
                    width: 100%;
                    text-align: center;
                }
                ul li:first-child {
                    margin-bottom: 0;
                }
                ul li:first-child .title {
                    font-size: 1.563em;
                }
            }

            /* Estilos para filtros */
            .filters {
                margin-bottom: 2rem;
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                align-items: center;
            }

            .filter-btn {
                padding: 0.5rem 1rem;
                border: 2px solid rgb(var(--accent));
                background: transparent;
                color: rgb(var(--accent));
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.2s ease;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .filter-btn:hover,
            .filter-btn.active {
                background: rgb(var(--accent));
                color: white;
            }

            .post-item {
                transition: opacity 0.3s ease;
            }

            .post-item.hidden {
                display: none;
            }

            /* Estilos para paginación */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1rem;
                margin-top: 3rem;
                padding: 2rem 0;
            }

            .pagination a,
            .pagination span {
                padding: 0.5rem 1rem;
                border: 2px solid rgb(var(--accent));
                border-radius: 8px;
                text-decoration: none;
                color: rgb(var(--accent));
                transition: all 0.2s ease;
                font-weight: 500;
            }

            .pagination a:hover {
                background: rgb(var(--accent));
                color: white;
            }

            .pagination .current {
                background: rgb(var(--accent));
                color: white;
            }

            .pagination .disabled {
                opacity: 0.3;
                cursor: not-allowed;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            <h1
                style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;"
            >
                Blog de {SITE_TITLE}
            </h1>
            <section>
                <!-- Componente de búsqueda -->
                <SearchBox />

                <div
                    class="filters"
                    role="group"
                    aria-label="Filtrar publicaciones por categoría"
                >
                    <span
                        style="font-weight: bold; margin-right: 1rem;"
                        id="filter-label">Filtrar por:</span
                    >
                    <button
                        class="filter-btn active"
                        data-filter="all"
                        aria-pressed="true">Todos</button
                    >
                    {
                        allCodes.map((code) => (
                            <button
                                class="filter-btn"
                                data-filter={code}
                                aria-pressed="false"
                            >
                                {code
                                    ? code.charAt(0).toUpperCase() +
                                      code.slice(1)
                                    : "Sin código"}
                            </button>
                        ))
                    }
                </div>

                <ul>
                    {
                        page.data.map((post) => (
                            <li
                                class="post-item"
                                data-code={post.data.code || "sin-codigo"}
                            >
                                <a href={`/blog/${post.id}/`}>
                                    <Image
                                        width={720}
                                        height={360}
                                        src={
                                            post.data.heroImage &&
                                            typeof post.data.heroImage ===
                                                "object"
                                                ? post.data.heroImage
                                                : DefaultImage
                                        }
                                        alt={post.data.title}
                                    />
                                    <h2 class="title">{post.data.title}</h2>
                                    <p class="date">
                                        <FormattedDate
                                            date={post.data.pubDate}
                                        />
                                    </p>
                                </a>
                            </li>
                        ))
                    }
                </ul>

                <!-- Controles de paginación -->
                <nav class="pagination" aria-label="Navegación de páginas">
                    {
                        page.url.prev ? (
                            <a
                                href={page.url.prev}
                                aria-label="Página anterior"
                            >
                                ← Anterior
                            </a>
                        ) : (
                            <span class="disabled">← Anterior</span>
                        )
                    }

                    <span class="current">
                        Página {page.currentPage} de {page.lastPage}
                    </span>

                    {
                        page.url.next ? (
                            <a
                                href={page.url.next}
                                aria-label="Página siguiente"
                            >
                                Siguiente →
                            </a>
                        ) : (
                            <span class="disabled">Siguiente →</span>
                        )
                    }
                </nav>
            </section>
        </main>
        <Footer />

        <script>
            // Funcionalidad de filtrado
            document.addEventListener("DOMContentLoaded", function () {
                const filterButtons = document.querySelectorAll(".filter-btn");
                const postItems = document.querySelectorAll(".post-item");

                filterButtons.forEach((button) => {
                    button.addEventListener(
                        "click",
                        function (this: HTMLButtonElement) {
                            const filter = this.getAttribute("data-filter");

                            // Actualizar botones activos
                            filterButtons.forEach((btn) => {
                                btn.classList.remove("active");
                                btn.setAttribute("aria-pressed", "false");
                            });
                            this.classList.add("active");
                            this.setAttribute("aria-pressed", "true");

                            // Filtrar posts
                            postItems.forEach((item) => {
                                const postCode = item.getAttribute("data-code");

                                if (filter === "all" || postCode === filter) {
                                    item.classList.remove("hidden");
                                } else {
                                    item.classList.add("hidden");
                                }
                            });
                        },
                    );
                });
            });
        </script>
    </body>
</html>
